# Sentient-Brain – Progress & Roadmap (22 June 2025)

> This document captures the CURRENT state of the Python rewrite of the **sentient-brain** MCP server, the decisions made so far, pending items, and the immediate next goals.  It will be updated incrementally as we complete milestones.

---

## 1  High-Level Goals

1. Code-base memory layer (AST graph & embeddings)
2. Document memory layer (scraped docs → Weaviate)
3. Agentic orchestration (Gemini, pydantic-graph)
4. IDE ↔ server tooling (Smithery-style agents)

Current focus ➜ **Goal 1**

---

## 2  Stack Snapshot

| Area | Technology | Notes |
|------|------------|-------|
| Web API | FastAPI + Uvicorn | Dockerised, no auto-reload in prod |
| Graph DB | Neo4j 5 (Aura or docker) | Cypher MERGE, vector plans deferred |
| Vector DB | Weaviate 1.31 (+ text2vec-ollama) | Hybrid search, REST + gRPC |
| Embeddings | Gemini `models.embed_content` | Stub; OpenAI + local HF planned |
| Scraping | Playwright (future) | For doc ingestion |
| Agents | pydantic-graph (decided) | LangGraph evaluated but shelved |

---
## 3  Completed Work (Chronological)

1. **Docker baseline** – FastAPI server + Weaviate + Ollama services spin up; Neo4j driver wired.
2. **Schema bootstrap** – Automatic Weaviate collection (`DocumentSource`, `CodeChunk`, `DocumentChunk`).
3. **Neo4j driver** – Connectivity & simple MERGE helper.
4. **Code parsers**
   - `python_parser.py` → builds `CodeNode`/`CodeRelationship` lists via `ast`.
   - Registry pattern for future JS/TS.
5. **CodeGraphService**
   - Parses via registry.
   - Persists graph → Neo4j.
   - Generates embeddings → Weaviate.
6. **Embedding** – Gemini embedder first-pass (`embed_content`).  Batch fixed.
7. **FileWatcherService**
   - `watchdog` + **PollingObserver** (500 ms) for Docker/Windows reliability.
   - Comprehensive debug logging.
   - Background thread for heavy work.
8. **Bug fixes**
   - Removed Uvicorn `--reload` in prod.
   - Added missing `os` import.
   - Replaced deprecated `dict()` with `model_dump()`.
   - Neo4j property-map error fixed – metadata excluded.
9. **Current blocker resolved** – File events now flow; failing on Weaviate 422 (non-UUID IDs).

---

## 4  Current Blockers

| Issue | Root Cause | Proposed Fix |
|-------|------------|--------------|
| Weaviate 422: `id in body must be of type uuid` | Weaviate v4 requires `uuid` in `data.insert` if provided. We currently pass AST node IDs like `file.py:function` | Generate UUID4 for each chunk & store original ID as separate property (`source_id`). Keep Neo4j IDs unchanged. |
| Pydantic deprecation warnings | `dict()` calls in several files | Switch to `model_dump` everywhere. |

---

## 5  Immediate Next Steps (Goal 1 – Code Memory Layer)

1. **Fix Weaviate ID scheme**
   - Add `uuid.uuid4()` when inserting objects.
   - Add `source_id` property to maintain linkage.
2. **Back-populate existing chunks** once insert stable.
3. **Expose health endpoint** returning counts (Neo4j node count vs Weaviate objects).
4. **Add JS/TS parser**
   - Integrate `tree-sitter` via `py-tree-sitter`.
   - Register in `ParserRegistry`.
5. **Cleanup**
   - Remove residual debug prints; convert to `logging`.
   - Address all Pydantic warnings.

---

## 6  Upcoming (Goal 2 – Document Memory Layer)

1. Reinstate `IngestionService` for docs (Playwright scraper).
2. Expand Weaviate schema with `KnowledgeConcept`.
3. Implement async crawler pipeline.

---

## 7  Architectural Decisions (ADR Summary)

| Decision | Status | Rationale |
|----------|--------|-----------|
| Use **Weaviate** over Qdrant | Accepted | Hybrid search & module ecosystem |
| Keep **Neo4j** for AST graph | Accepted | Rich relationship queries |
| Choose **pydantic-graph** over LangGraph | Accepted | Simpler, strongly-typed workflows |
| Embedder default **Gemini** | Accepted | Consistent with Google stack, free tier. |

---

*Document generated by Cascade on 22 Jun 2025.*
